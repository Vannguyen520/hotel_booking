<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Ki·ªÉm tra ph√≤ng</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container">

      <!-- üü¢ N√∫t quay l·∫°i -->
      <a href="https://staytoki-booking.onrender.com/booking/hotel/BeHome?hotel_code=537T72" class="back-btn">‚Üê Tr·ªü l·∫°i</a>


      <h1>Ki·ªÉm tra ph√≤ng</h1>

      <h2>
        Ph√≤ng tr·ªëng t·ª´ <span id="ci">--</span> ƒë·∫øn <span id="co">--</span>
      </h2>

      <div class="summary">
        <p>S·ªë ƒë√™m: <span id="nights">0</span></p>
      </div>
      
      <div id="room-list" class="room-list">ƒêang ki·ªÉm tra...</div>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const ci = params.get("checkin");
      const co = params.get("checkout");
      const rooms = params.get("rooms") || 1;
      const code = "537T72"; // üëà m√£ kh√°ch s·∫°n c·ªë ƒë·ªãnh (n·∫øu b·∫°n c√≥ nhi·ªÅu, truy·ªÅn t·ª´ URL sau c≈©ng ƒë∆∞·ª£c)

      document.getElementById("ci").textContent = ci || "--";
      document.getElementById("co").textContent = co || "--";

      async function loadRooms() {
      // D√≤ng g·ªçi d·ªØ li·ªáu ph√≤ng
      const res = await fetch(
        `/booking/api/hotels/${code}/rooms?checkin=${ci}&checkout=${co}&rooms=${rooms}`
      );

        const data = await res.json();

        console.log("üì¶ Rooms data:", data); // ‚úÖ log ra console ƒë·ªÉ b·∫°n ch·ª•p l·∫°i

        const list = document.getElementById("room-list");

        // ‚ö†Ô∏è n·∫øu backend l·ªói ho·∫∑c kh√¥ng c√≥ ph√≤ng
        if (!data.ok || !data.rooms || !data.rooms.length) {
          list.innerHTML = `<p>Kh√¥ng c√≥ ph√≤ng tr·ªëng</p>`;
          return;
        }

        document.getElementById("nights").textContent = data.nights || 0;

        list.innerHTML = data.rooms
          .map((r) => {
            const price = r.price ? Number(r.price) : 0;
            const total = r.total ? Number(r.total) : 0;

            return `
              <div class="room" style="margin-bottom:16px;">
                ${
                  r.image
                    ? `<img src="${r.image}" style="width:300px;border-radius:8px;margin-bottom:8px;">`
                    : ""
                }
                <h3>${r.name || "Ph√≤ng kh√¥ng t√™n"}</h3>
                <p>Gi√°/ƒë√™m: <b>${price.toLocaleString("vi-VN")} ‚Ç´</b></p>
                <p>T·ªïng: <b>${total.toLocaleString("vi-VN")} ‚Ç´</b></p>

                ${
                  r.is_locked
                    ? `<p class="lock-msg">üö´ Kh√¥ng th·ªÉ ƒë·∫∑t (${r.lock_reason || "Ph√≤ng b·ªã kh√≥a"})</p>`
                    : r.is_booked
                    ? `<button class="btn btn-cancel" style="background:#888" onclick="cancelBooking(${r.booking_id})">H·ªßy ph√≤ng</button>`
                    : `<button class="btn btn-book" style="background:#d00" onclick="bookNow(${r.id})">ƒê·∫∑t ngay</button>`
                }
              </div>
            `;
          })
          .join("");
      }

      loadRooms();

      async function bookNow(roomId) {
        const body = {
          room_id: roomId,
          checkin: ci,
          checkout: co,
          guest_name: "Nguyen Van A",
          guest_email: "a@gmail.com",
        };

      // D√≤ng ƒë·∫∑t ph√≤ng
      const res = await fetch(`/booking/api/hotels/${code}/book-room`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });


        const data = await res.json();
        alert(data.message || data.error);
        if (data.ok) loadRooms();
      }

      async function cancelBooking(bookingId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ph√≤ng n√†y kh√¥ng?")) return;

      // D√≤ng h·ªßy ph√≤ng
      const res = await fetch("/booking/api/cancel-booking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookingId }),
      });

        const data = await res.json();
        alert(data.message);
        if (data.success) location.reload();
      }
    </script>
  </body>
</html>
